---
title: "Final_Project_Miko"
author: "Miko"
date: "2022-12-06"
output: html_document
---

```{r setup, include=FALSE}
library(ezids)
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "markup", message = F)
options(scientific=T, digits = 3) 
```




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(ezids)
library(dplyr)
library(readr)
library(tidyr)
library(knitr)
library(magrittr)
```

```{r }
df_2016<-data.frame(read.csv("Arrests 2016 Public.csv"))
df_2017<-data.frame(read.csv("Arrests 2017 Public.csv"))
df_2018<-data.frame(read.csv("Arrests by Year, 2018.csv"))
df_2019<-data.frame(read.csv("Arrests by Year, 2019.csv"))
df_2020<-data.frame(read.csv("Arrests by Year 2020.csv"))
df_2021<-data.frame(read.csv("2021 Adult Arrests.csv"))
c16 <- c(colnames(df_2016))
c18 <- c(colnames(df_2018))
```

```{r}
# convert format
df_2018$Arrest.Date <- as.Date(df_2018$Arrest.Date, format = "%m/%d/%Y") %>% format()
df_2019$Arrest.Date <- as.Date(df_2019$Arrest.Date, format = "%m/%d/%Y") %>% format()
df_2020$Arrest.Date <- as.Date(df_2020$Arrest.Date, format = "%m/%d/%Y") %>% format()
df_2021$Arrest.Date <- as.Date(df_2021$Arrest.Date, format = "%Y/%m/%d") %>% format()
#bind df_2016 and df_2017, and delete some columns
df_16_17 <- rbind(df_2016, df_2017)[,-c(5,6,15,17:21,23:26)]
names(df_16_17)[c(13,14)] <- c('Arrest.Location.District','Offense.Location.District')   #rename columns
#bind df_2018 - df_2021, and delete some columns
df_18_21 <- rbind(df_2018, df_2019, df_2020, df_2021)[,-c(5,6,15,17:21,23:26)] 
DF<-rbind(df_16_17,df_18_21)
```

```{r}
xkablesummary(subset(DF,select=c(Arrest.Year, Arrest.Hour, Age)))
```

```{r}
DF <- DF[!DF$Age>=100,]
names(DF) = gsub("[.]", "_", names(DF))
colnames(DF)
str(DF)
```

```{r}
#find unique values in the race, sex and arrest_category columns.
#unique(DF$Defendant_Race)
#unique(DF$Defendant_Sex)
#unique(DF$Arrest_Category)
# most likely "UNK" is the same as "Unknown", so we can change this
DF$Defendant_Race[DF$Defendant_Race == 'UNK'] <- 'UNKNOWN'
#unique(DF$Defendant_Race) - check that it changed
#same issue, "unk" is very likely "unknown", so change it.
DF$Defendant_Sex[DF$Defendant_Sex == 'UNK'] <- 'UNKNOWN'
#unique(DF$Defendant_Sex) - check that it changed
# Arrest category -  4 different types of Fraud & Financial crimes , 3 types of Release Violations/Fugitive -- group them into one.
DF$Arrest_Category = gsub("Fraud and Financial Crimes.*","Fraud and Financial Crimes", DF$Arrest_Category)
DF$Arrest_Category = gsub("Release Violations/Fugitive.*","Release Violations/Fugitive",DF$Arrest_Category)
#sort(unique(DF$Arrest_Category)) - check that new changes were made.
```

### Missing Values
```{r}
sapply(DF, function(x) sum(is.na(x)))
```
##### Our variables of concern in thsi dataset contain rich data.. over 95% of data available in each useful column.. will not delete any rows


```{r}
#get month and day variables.. might be interesting, who knows?
DF <- separate(DF, col = Arrest_Date, into = c("Year","Month","Day"), sep = "-", remove = FALSE, fill="left")
#remove the new year column formed, it is redundant.. we already have Year column
DF = DF[,-4]
colnames(DF)
```


```{r}
library(lubridate)
# Factorize some variables
DF$Arrest_Year = as.factor(DF$Arrest_Year)
DF$Month = as.factor(DF$Month)
DF$Day = as.factor(DF$Day)
DF$Defendant_Race = as.factor(DF$Defendant_Race)
DF$Defendant_Sex = as.factor(DF$Defendant_Sex)
DF$Arrest_Location_District = as.factor(DF$Arrest_Location_District)
DF$Offense_Location_District = as.factor(DF$Offense_Location_District)
# convert to date format
DF$Arrest_Date = as.Date(DF$Arrest_Date)
# Day format
DF$Day = day(DF$Arrest_Date)
# i want to create a week-day variable
DF$Weekday = weekdays(DF$Arrest_Date)
DF$Weekday = factor(DF$Weekday, levels = as.character(wday(c(2:7,1), label=TRUE, abbr=FALSE)))
# convert crime types to factors
DF$Arrest_Category = as.factor(DF$Arrest_Category)
```


### Correct inconsistent values    
`Arrest_Category` had some different values for 2021 and other years:  

* Data in 2021 had "Release Violations/Fugitive (Fug)" and "Release Violations/Fugitive (Warr)" although data in other years have "Release Violations/Fugitive" instead of them.  
* Data in 2021 had "Fraud and Financial Crimes (Frau)" although data in other years have "Fraud and Financial Crimes".  

Therefore, we coverted these values in 2021 into the correspond values in other years.  


```{r}
DF <- mutate(DF, Arrest_Category = gsub(Arrest_Category, pattern = "Release Violations/Fugitive.*", replacement = "Release Violations/Fugitive"))
DF <- mutate(DF, Arrest_Category = gsub(Arrest_Category, pattern = "Fraud and Financial Crimes.*", replacement = "Fraud and Financial Crimes"))
```

## Remove Unnecessary Rows  
Since we were interested in crimes committed by while males, we dropped rows where the value of `Defendant_Race` was not "White". The structure of the final data is shown in the below table.

```{r}
DF_WM <- subset(DF, subset = Defendant_Race=='WHITE' & Defendant_Sex=='MALE')
data.frame(column_name = names(DF_WM),
           class = sapply(DF_WM, typeof),
           first_values = sapply(DF_WM, function(x) paste0(head(x),  collapse = ", ")),
           row.names = NULL) %>% 
  kable("simple", caption = 'Data frame structure')
library(dplyr)
n_distinct(DF$Arrest_Category)
unique(DF$Arrest_Category)
```
##Model

There are two fields in the data which provide the description of the crime incident. The first, primary description provides a broad category of the crime type and the second provides more detailed information about the first. We use the primary description to categorize different crime types.


The data contains 30 crime types; not all of which are mutually exclusive. We can combine two or more similar categories into one to reduce this number and make the analysis a bit more manageable.



```{r }

na.omit(DF)

library(forcats)

DF<-DF %>%
  mutate(
    crime=fct_recode(Arrest_Category ,
                     "ASSAULT"="Simple Assault",
                     "ASSAULT"="Assault on a Police Officer",
                     "ASSAULT"="Assault with a Dangerous Weapon",
                     "ASSAULT"="Aggravated Assault",
                     "TRAFFIC"="Traffic Violations",
                     "THEFT"="Theft",
                     "THEFT"="Theft from Auto",
                     "THEFT"="Motor Vehicle Theft",
                     "FRAUD"="Fraud and Financial Crimes",
                     "SEX"="Sex Offenses",
                     "SEX"="Sex Abuse",
                     "VIOLENT"="Weapon Violations",
                     "VIOLENT"="Kidnapping",
                     "VIOLENT"="Release Violations/Fugitive",
                     "VIOLENT"="Damage to Property",
                     "DRUG"="Narcotics",
                     "NONVIOLENT"="Driving/Boating While Intoxicated",
                     "NONVIOLENT"="Disorderly Conduct",
                     "NONVIOLENT"="Liquor Law Violations",
                     "OTHERS"="Other Crimes",
                     "ASSAULT"="Offenses Against Family & Children",
                     "OTHERS"="NA",
                     "OTHERS"="Property Crimes",
                     "VIOLENT"="Vending Violations",
                     "VIOLENT"="Robbery",
                     "THEFT"="Burglary",
                     "SEX"="Prostitution",
                     "VIOLENT"="Homicide",
                     "NONVIOLENT"="Gambling",

                     "OTHERS"="Arson"
                     
                     ),
    crime_type=fct_recode(crime,
                          "VIOLENT"="SEX",
                          "VIOLENT"="ASSAULT",
                          "VIOLENT"="VIOLENT",
                          "NONVIOLENT"="TRAFFIC",
                          "NONVIOLENT"="FRAUD",
                          "NONVIOLENT"="THEFT",
                          "NONVIOLENT"="NONVIOLENT",
                          "NONVIOLENT"="DRUG",
                          "OTHERS"="OTHERS"

                          ) # Further combination into violent and non-violent crime types
  )
DF %>%
  group_by(crime) %>%
  summarize(count=n()) %>%
  arrange(desc(count))
```

```{r }
library(scales)
DF %>%
  group_by(crime,Month) %>%
  summarise(count=n()) %>%
  ggplot(aes(x=crime, y=Month)) +
  geom_tile(aes(fill=count)) +
  labs(x="Crime", y = "Month of year", title="Spring and Summer is popular for crimes") +
  scale_fill_viridis_c("Number of Crimes",label=comma) +
  coord_flip()
```


A quick look at the heat map shows that most of the spring and summer.



```{r }
(dates <- crime_agg %>%
    ungroup() %>%
    distinct(Arrest_Date) %>%
    arrange(Arrest_Date))
```





```{r }
(crime_agg <- group_by(DF, crime, Arrest_Date) %>%
  summarise(count = n())) %>%
  arrange(desc(count))
```


By ordering this, we can see from all the data, assault happens 183 times at 2020-06-01.




```{r}
DF %>%
  group_by(crime_type) %>%
  summarize(count=n()) %>%
  arrange(count)

```


Violent crime is far more than nonviolent crime. 




####Class by seasons
Our visualization exercise showed that there is considerable variation in crime incidents with respect to the time of the year. But we have only 1 year of data for both building the model and validating it. To use the month variable effectively, we can combine the similar months to form a new variable that reflects the changes in crime incidents with seasons.




```{r }
(model_data <- DF %>%
   mutate(season=fct_recode(Month,
                     "spring"="03",
                     "spring"="04",
                     "spring"="05",
                     "summer"="06",
                     "summer"="07",
                     "summer"="08",
                     "fall"="09",
                     "fall"="10",
                     "fall"="11",
                     "winter"="12",
                     "winter"="01",
                     "winter"="02"
                     ),
          season=as_factor(season)
          )
  )

```


